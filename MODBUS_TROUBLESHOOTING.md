# Диагностика проблем с Modbus реле WS14

## Проблема: Реле не запускаются

### Возможные причины и решения:

## 1. Проверка адресации (самая частая проблема)

В Modbus адреса могут быть **0-based** (начинаются с 0) или **1-based** (начинаются с 1).

**Текущая конфигурация использует адреса 1-30.**

**Попробуйте изменить на 0-based (адреса 0-29):**

```yaml
switches:
  - name: "Брудер_1_Реле_1"
    address: 0    # Было: 1
    write_type: coil
    slave: 1
  - name: "Брудер_1_Реле_2"
    address: 1    # Было: 2
    write_type: coil
    slave: 1
  # ... и так далее
```

## 2. Проверка подключения

Выполните на сервере Home Assistant:

```bash
# Проверка доступности устройства
ping 192.168.88.47

# Проверка порта
telnet 192.168.88.47 4196
# или
nc -zv 192.168.88.47 4196
```

## 3. Проверка логов

```bash
# На сервере Home Assistant
ha core logs | grep -i modbus
ha core logs | grep -i ws14
```

## 4. Проверка slave адреса

WS14 работает как шлюз Modbus TCP to RTU. Возможно, slave адрес должен быть другим.

**Попробуйте изменить slave:**
- `slave: 1` (текущее)
- `slave: 0` (если устройство использует адрес 0)
- Или убрать параметр `slave` вообще

## 5. Добавление параметров для чтения состояния

Попробуйте добавить параметры для чтения состояния реле:

```yaml
switches:
  - name: "Брудер_1_Реле_1"
    address: 1
    write_type: coil
    slave: 1
    scan_interval: 5  # Обновление состояния каждые 5 секунд
```

## 6. Изменение типа записи

Попробуйте разные варианты:

```yaml
# Вариант 1 (текущий)
write_type: coil

# Вариант 2 (если не работает)
# Убрать write_type вообще или попробовать:
# (но для реле обычно coil)
```

## 7. Увеличение таймаутов

Попробуйте увеличить таймауты:

```yaml
modbus:
  - name: WS14
    type: tcp
    host: 192.168.88.47
    port: 4196
    delay: 50      # Увеличено с 10 до 50
    timeout: 10    # Увеличено с 3 до 10
```

## 8. Проверка через Developer Tools

В Home Assistant:
1. **Настройки** → **Инструменты разработчика** → **Сервисы**
2. Найдите сервис `modbus.write_coil` или `switch.turn_on`
3. Попробуйте включить реле вручную

## 9. Тестирование с минимальной конфигурацией

Попробуйте сначала одно реле:

```yaml
modbus:
  - name: WS14
    type: tcp
    host: 192.168.88.47
    port: 4196
    delay: 10
    timeout: 3
    switches:
      - name: "Test_Relay_1"
        address: 0    # Попробуйте 0
        write_type: coil
        slave: 1
```

## 10. Проверка настроек WS14

Убедитесь, что в веб-интерфейсе WS14:
- **Protocol:** Modbus TCP to RTU
- **Work Mode:** TCP Server
- **Port:** 4196
- Устройства на RTU шине имеют правильные Modbus адреса

## Рекомендуемый порядок проверки:

1. ✅ Проверьте подключение (ping, telnet)
2. ✅ Проверьте логи Home Assistant
3. ✅ Попробуйте изменить адреса на 0-based (0-29 вместо 1-30)
4. ✅ Попробуйте изменить slave адрес
5. ✅ Увеличьте таймауты
6. ✅ Протестируйте с одним реле

## Быстрое исправление (попробуйте первым):

Измените адреса на 0-based:

```yaml
switches:
  - name: "Брудер_1_Реле_1"
    address: 0    # Изменить с 1 на 0
    write_type: coil
    slave: 1
  - name: "Брудер_1_Реле_2"
    address: 1    # Изменить с 2 на 1
    write_type: coil
    slave: 1
  # ... и так далее для всех реле
```

