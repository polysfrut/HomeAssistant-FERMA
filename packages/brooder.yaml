# ----------------------------------------------------------------------
# Проект: Автоматизация перепелиной фермы (брудер) на Home Assistant
# Протокол: Modbus RTU (RS485) + WaveShare реле/датчики
# Автор: dmk2025 (xAI) – реализация алгоритма пользователя
# ----------------------------------------------------------------------
# 1. ВХОДНЫЕ ПАРАМЕТРЫ (input_number) – меняются в UI
# 2. КНОПКИ (input_button)
# 3. СТАТУСЫ (input_text + sensor)
# 4. АВТОМАТИЗАЦИИ (automation) – весь алгоритм
# ----------------------------------------------------------------------
# Требования:
#   • modbus: уже настроен (hub "waveshare001")
#   • notify: любой (например, mobile_app или telegram)
#   • shell_command: нет


# ======================================================================
# 1. INPUT_NUMBER – переменные управления (UI)
# ======================================================================
input_number:
  ir_time_56:                     # "Время ИК лампы 5-6" (дней)
    name: Время ИК лампы 5-6
    min: 1
    max: 10
    initial: 7
    step: 1
    unit_of_measurement: дней
    icon: mdi:timer

  ir_time_34:                     # "Время ИК лампы 3-4" (дней)
    name: Время ИК лампы 3-4
    min: 1
    max: 10
    initial: 2
    step: 1
    unit_of_measurement: дней
    icon: mdi:timer

  ir_time_12:                     # "Время ИК лампы 1-2" (дней)
    name: Время ИК лампы 1-2
    min: 1
    max: 10
    initial: 1
    step: 1
    unit_of_measurement: дней
    icon: mdi:timer

  work_cycle:                     # "Рабочий цикл" (дней)
    name: Рабочий цикл
    min: 1
    max: 15
    initial: 14
    step: 1
    unit_of_measurement: дней
    icon: mdi:calendar-clock

  min_temp:                       # "Мин Температура брудера"
    name: Мин Температура брудера
    min: 20
    max: 40
    initial: 30
    step: 0.5
    unit_of_measurement: °C
    icon: mdi:thermometer-low

  max_temp:                       # "Макс Температура брудера"
    name: Макс Температура брудера
    min: 20
    max: 40
    initial: 37
    step: 0.5
    unit_of_measurement: °C
    icon: mdi:thermometer-high

  min_hum:                        # "Мин влажность брудера"
    name: Мин влажность брудера
    min: 40
    max: 70
    initial: 60
    step: 1
    unit_of_measurement: '%'
    icon: mdi:water-percent

  max_hum:                        # "Макс влажность брудера"
    name: Макс влажность брудера
    min: 40
    max: 70
    initial: 65
    step: 1
    unit_of_measurement: '%'
    icon: mdi:water-percent

  dehum_min_temp:                 # "Мин температура для осушения"
    name: Мин температура для осушения
    min: 25
    max: 35
    initial: 31
    step: 0.5
    unit_of_measurement: °C
    icon: mdi:thermometer

  fan_min_on:                     # "Мин время работы вентилятора"
    name: Мин время работы вентилятора
    min: 1
    max: 10
    initial: 3
    step: 1
    unit_of_measurement: мин
    icon: mdi:timer

  temp_fan_hysteresis:            # "Гистерезис температуры для вентилятора (возврат от max_temp)"
    name: Гистерезис температуры вентилятора
    min: 0.1
    max: 2.0
    initial: 0.6
    step: 0.1
    unit_of_measurement: °C
    icon: mdi:thermometer

  ten1_start_temp:                # Температура при включении ТЭН1
    name: ТЭН1 старт температура
    min: 0
    max: 50
    initial: 0
    step: 0.1
    unit_of_measurement: °C
    icon: mdi:thermometer


# ======================================================================
# 2. INPUT_BUTTON – программные кнопки
# ======================================================================
input_button:
  start_brooder:                  # "Запустить брудер"
    name: Запустить брудер
    icon: mdi:play-circle

  preheat:                        # "Прогрев"
    name: Прогрев
    icon: mdi:heat-wave

  lighting:                       # "Освещение"
    name: Освещение
    icon: mdi:lightbulb-on

  ir_lamps:                       # "ИК лампы"
    name: ИК лампы
    icon: mdi:lightbulb-outline

  stop_brooder:                   # "Остановить брудер"
    name: Остановить брудер
    icon: mdi:stop-circle

# Кнопка сброса аварии (программная)
input_boolean:
  ruchnoi_rezhim:
    name: Ручной режим
    initial: off
    icon: mdi:hand-back-left

  avtomaticheskii_rezhim:
    name: Автоматический режим
    initial: on
    icon: mdi:robot

# ======================================================================
# 3. INPUT_TEXT / INPUT_DATETIME – статусы и таймеры
# ======================================================================
input_text:
  brooder_state:                  # "Состояние брудера"
    max: 100
    name: Состояние брудера
    initial: Ожидание
    icon: mdi:information-outline

input_datetime:
  init_time:                      # Дата/время установки "Инициализация"
    name: Время инициализации
    has_date: true
    has_time: true

  ir_on_time:                     # Дата/время включения ИК ламп
    name: ИК лампы включены
    has_date: true
    has_time: true

  ir_off_56:                      # Плановое отключение ИК 5-6
    name: Откл. ИК 5-6
    has_date: true
    has_time: true

  ir_off_34:                      # Плановое отключение ИК 3-4
    name: Откл. ИК 3-4
    has_date: true
    has_time: true

  ir_off_12:                      # Плановое отключение ИК 1-2
    name: Откл. ИК 1-2
    has_date: true
    has_time: true

  lighting_start:                 # "Освещение включено"
    name: Освещение включено
    has_date: true
    has_time: true

  ten1_start_time:                # Время включения ТЭН1
    name: ТЭН1 старт время
    has_date: true
    has_time: true

  fan_start_time:                 # Время включения вентилятора
    name: Вентилятор старт время
    has_date: true
    has_time: true

  fan_stop_time:                  # Время отключения вентилятора
    name: Вентилятор стоп время
    has_date: true
    has_time: true


# ======================================================================
# 4. TEMPLATE SENSORS – вспомогательные (для удобства)
# ======================================================================
# Template sensors определены в configuration.yaml
# Здесь удалены дубликаты для избежания конфликтов

template:
  - sensor:
      - name: "all_ir_off"
        unique_id: all_ir_off
        state: >
          {% if is_state('switch.waveshare001_relay_5', 'off') and
                is_state('switch.waveshare001_relay_6', 'off') and
                is_state('switch.waveshare001_relay_7', 'off') %}
            true
          {% else %}
            false
          {% endif %}


# ======================================================================
# 5. УТИЛИТЫ – уведомления
# ======================================================================
# Замените "notify.mobile_app_your_phone" на ваш реальный notifier
notify:
    platform: telegram
    chat_id: -4042989566
    name: brooder_notify

script:
  send_notify:
    sequence:
      - service: notify.brooder_notify
        data:
          message: >-
            Брудер 1. {{ message }} Дата {{ now().strftime('%d.%m.%Y %H:%M') }}.
            T={{ states('sensor.waveshare001_rs485_temperature_10') }}°C,
            H={{ states('sensor.waveshare001_rs485_humidity_10') }}%.

# ======================================================================
# SCRIPT: Остановка брудера (общий)
# ======================================================================
  stop_brooder:
    sequence:
      # 1. Устанавливаем состояние "Ожидание" ПЕРВЫМ (чтобы автоматизации не включали устройства)
      - service: input_text.set_value
        data:
          entity_id: input_text.brooder_state
          value: Ожидание
      # 2. Отключаем ВСЁ оборудование
      - service: switch.turn_off
        target:
          entity_id:
            - switch.waveshare001_relay_1   # ТЭН1
            - switch.waveshare001_relay_2   # ТЭН2
            - switch.waveshare001_relay_3   # Вент.1
            - switch.waveshare001_relay_4   # Вент.2
            - switch.waveshare001_relay_5   # ИК 1-2
            - switch.waveshare001_relay_6   # ИК 3-4
            - switch.waveshare001_relay_7   # ИК 5-6
            - switch.waveshare001_relay_8   # Освещение
      # 3. Сбрасываем причину вентилятора
      - service: input_text.set_value
        data:
          entity_id: input_text.fan_reason
          value: ""
      # 4. Отключаем автоматический режим
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.avtomaticheskii_rezhim
      # 5. Уведомление
      - service: script.send_notify
        data:
          message: "Брудер остановлен. Все устройства отключены. Автоматический режим выключен."

# ======================================================================
# 6. АВТОМАТИЗАЦИИ
# ======================================================================
automation:

  # -------------------------------------------------
  # 1.1 Кнопка "Прогрев" → Включение всех ИК ламп и всех ТЭНов (только в ручном режиме)
  # -------------------------------------------------
  - alias: "[Брудер] Кнопка Прогрев → Включение всех ИК ламп и всех ТЭНов"
    trigger:
      - platform: state
        entity_id: input_button.preheat
    condition:
      # Ручной режим ДОЛЖЕН быть включен
      - condition: state
        entity_id: input_boolean.ruchnoi_rezhim
        state: "on"
    action:
      # 1.1 Установить состояние "Подогрев" ПЕРВЫМ (чтобы другие автоматизации не мешали)
      - service: input_text.set_value
        data:
          entity_id: input_text.brooder_state
          value: Подогрев
      
      # 1.2 Отключить освещение и вентиляторы
      - service: switch.turn_off
        target:
          entity_id:
            - switch.waveshare001_relay_8   # Освещение
            - switch.waveshare001_relay_3   # Вент.скор.1
            - switch.waveshare001_relay_4   # Вент.скор.2
      
      # 1.3 Включить все ИК лампы
      - service: switch.turn_on
        target:
          entity_id:
            - switch.waveshare001_relay_5   # ИК 1-2
            - switch.waveshare001_relay_6   # ИК 3-4
            - switch.waveshare001_relay_7   # ИК 5-6
      
      # 1.4 Включить ТЭН1 и ТЭН2
      - service: switch.turn_on
        target:
          entity_id:
            - switch.waveshare001_relay_1   # ТЭН1
            - switch.waveshare001_relay_2   # ТЭН2
      
      # 1.5 Запомнить время начала прогрева
      - service: input_datetime.set_datetime
        data:
          entity_id: input_datetime.ten1_start_time
          timestamp: "{{ now().timestamp() | int }}"
      - service: input_number.set_value
        data:
          entity_id: input_number.ten1_start_temp
          value: "{{ states('sensor.waveshare001_rs485_temperature_10')|float }}"
      
      # 1.6 Уведомление
      - delay: "00:00:01"  # Небольшая задержка, чтобы реле успели включиться
      - service: notify.brooder_notify
        data:
          message: >-
            Прогрев запущен (ручной режим). Включены все ИК лампы и ТЭНы.
            Текущая температура {{ states('sensor.waveshare001_rs485_temperature_10') }}°C,
            цель {{ states('input_number.max_temp') }}°C.

  # -------------------------------------------------
  # 1.3 Подогрев (ТЭНы + ИК)
  # -------------------------------------------------
  - alias: "[Брудер] Подогрев – ТЭН1 (при достижении температуры min_temp)"
    trigger:
      - platform: template
        value_template: "{{ states('sensor.waveshare001_rs485_temperature_10')|float <= (states('input_number.min_temp')|float + 0.01) }}"
        # Срабатывает когда температура <= min_temp (достигает или падает ниже минимума)
    condition:
      # Автоматический режим включен
      - condition: state
        entity_id: input_boolean.avtomaticheskii_rezhim
        state: "on"
      # НЕ в ручном режиме
      - condition: state
        entity_id: input_boolean.ruchnoi_rezhim
        state: "off"
      # НЕ в состоянии "Ожидание" (чтобы кнопка Стоп работала)
      - condition: not
        conditions:
          - condition: state
            entity_id: input_text.brooder_state
            state: "Ожидание"
      # НЕ в состоянии "Подогрев" (режим прогрева управляется кнопкой "Прогрев")
      - condition: not
        conditions:
          - condition: state
            entity_id: input_text.brooder_state
            state: "Подогрев"
      # Включаем ТЭН1 только если он еще не включен
      - condition: state
        entity_id: switch.waveshare001_relay_1
        state: "off"
      # Не включаем если уже работает ТЭН2 (чтобы не переключать обратно)
      - condition: state
        entity_id: switch.waveshare001_relay_2
        state: "off"
    action:
      - service: switch.turn_on
        target:
          entity_id: switch.waveshare001_relay_1   # ТЭН1
      - service: input_datetime.set_datetime
        data:
          entity_id: input_datetime.ten1_start_time
          timestamp: "{{ now().timestamp() | int }}"
      - service: input_number.set_value
        data:
          entity_id: input_number.ten1_start_temp
          value: "{{ states('sensor.waveshare001_rs485_temperature_10')|float }}"
      - service: script.send_notify
        data:
          message: "ТЭН1 включён. Температура {{ states('sensor.waveshare001_rs485_temperature_10') }}°C (достигла минимума {{ states('input_number.min_temp') }}°C)."

  - alias: "[Брудер] Подогрев – контроль ТЭН1 → ТЭН2 (через 5 минут)"
    trigger:
      - platform: time_pattern
        minutes: "/1"   # проверка каждую минуту
    condition:
      # Автоматический режим включен
      - condition: state
        entity_id: input_boolean.avtomaticheskii_rezhim
        state: "on"
      # НЕ в ручном режиме
      - condition: state
        entity_id: input_boolean.ruchnoi_rezhim
        state: "off"
      # ТЭН1 должен быть включен
      - condition: state
        entity_id: switch.waveshare001_relay_1
        state: "on"
      # ТЭН2 еще не включен
      - condition: state
        entity_id: switch.waveshare001_relay_2
        state: "off"
      # Прошло 5 минут с момента включения ТЭН1
      - condition: template
        value_template: >-
          {{ (as_timestamp(now()) - as_timestamp(states.input_datetime.ten1_start_time.state)) / 60 >= 5 }}
      # Условие: температура стоит (не поднимается) или падает
      # Температура не поднялась выше начальной (стоит или падает)
      - condition: template
        value_template: >-
          {{ states('sensor.waveshare001_rs485_temperature_10')|float <= states('input_number.ten1_start_temp')|float }}
    action:
      - service: switch.turn_on
        target:
          entity_id: switch.waveshare001_relay_2   # ТЭН2
      - service: script.send_notify
        data:
          message: >-
            ТЭН2 включён. За 5 минут температура не поднялась (было {{ states('input_number.ten1_start_temp') }}°C, сейчас {{ states('sensor.waveshare001_rs485_temperature_10') }}°C). Оба ТЭНа будут работать до {{ states('input_number.max_temp') }}°C.

  # -------------------------------------------------
  # 1.4 Отключение ТЭНов при достижении max_temp (для режима "Прогрев")
  # -------------------------------------------------
  - alias: "[Брудер] Прогрев – отключение ТЭНов при достижении max_temp"
    trigger:
      - platform: numeric_state
        entity_id: sensor.waveshare001_rs485_temperature_10
        above: input_number.max_temp
    condition:
      # Автоматический режим включен
      - condition: state
        entity_id: input_boolean.avtomaticheskii_rezhim
        state: "on"
      # НЕ в ручном режиме
      - condition: state
        entity_id: input_boolean.ruchnoi_rezhim
        state: "off"
      # Работает только в состоянии "Подогрев" (режим прогрева)
      - condition: state
        entity_id: input_text.brooder_state
        state: "Подогрев"
      # Хотя бы один ТЭН включен
      - condition: or
        conditions:
          - condition: state
            entity_id: switch.waveshare001_relay_1
            state: "on"
          - condition: state
            entity_id: switch.waveshare001_relay_2
            state: "on"
    action:
      # Отключаем оба ТЭНа при достижении max_temp
      - service: switch.turn_off
        target:
          entity_id:
            - switch.waveshare001_relay_1   # ТЭН1
            - switch.waveshare001_relay_2   # ТЭН2
      - service: script.send_notify
        data:
          message: "Прогрев завершён. ТЭНы отключены. Температура достигла {{ states('sensor.waveshare001_rs485_temperature_10') }}°C (максимум {{ states('input_number.max_temp') }}°C). ИК лампы продолжают работать."

  # -------------------------------------------------
  # 1.5 Логика работы ВЕНТИЛЯТОРА (по температуре и влажности, с защитой минимальной температуры)
  # -------------------------------------------------
  
  # 1. Включение вентилятора по ВЛАЖНОСТИ
  - alias: "[Брудер] Вентилятор – включение по влажности"
    trigger:
      - platform: numeric_state
        entity_id: sensor.waveshare001_rs485_humidity_10
        above: input_number.max_hum
      - platform: numeric_state
        entity_id: sensor.waveshare001_rs485_temperature_10
        above: input_number.dehum_min_temp
    condition:
      # Автоматический режим включен
      - condition: state
        entity_id: input_boolean.avtomaticheskii_rezhim
        state: "on"
      # НЕ в ручном режиме
      - condition: state
        entity_id: input_boolean.ruchnoi_rezhim
        state: "off"
      # Вентилятор выключен
      - condition: state
        entity_id: switch.waveshare001_relay_3
        state: "off"
      # Прошло минимум 5 минут с последнего отключения (период покоя)
      - condition: or
        conditions:
          - condition: template
            value_template: "{{ states('input_datetime.fan_stop_time') == 'unknown' or states('input_datetime.fan_stop_time') == '' }}"
          - condition: template
            value_template: >-
              {{ (as_timestamp(now()) - as_timestamp(states.input_datetime.fan_stop_time.state)) / 60 >= 5 }}
      # Не в состоянии "Ожидание"
      - condition: not
        conditions:
          - condition: state
            entity_id: input_text.brooder_state
            state: "Ожидание"
    action:
      - service: switch.turn_on
        target:
          entity_id: switch.waveshare001_relay_3   # Вент.скор.1
      - service: input_datetime.set_datetime
        data:
          entity_id: input_datetime.fan_start_time
          timestamp: "{{ now().timestamp() | int }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.fan_reason
          value: "humidity"
      - service: script.send_notify
        data:
          message: >-
            Вентилятор включён по влажности. Влажность {{ states('sensor.waveshare001_rs485_humidity_10') }}%
            (макс {{ states('input_number.max_hum') }}%), температура {{ states('sensor.waveshare001_rs485_temperature_10') }}°C.

  # 2. Включение вентилятора по ТЕМПЕРАТУРЕ (перегрев)
  - alias: "[Брудер] Вентилятор – включение по температуре (перегрев)"
    trigger:
      - platform: numeric_state
        entity_id: sensor.waveshare001_rs485_temperature_10
        above: input_number.max_temp
    condition:
      # Автоматический режим включен
      - condition: state
        entity_id: input_boolean.avtomaticheskii_rezhim
        state: "on"
      # НЕ в ручном режиме
      - condition: state
        entity_id: input_boolean.ruchnoi_rezhim
        state: "off"
      # Вентилятор выключен
      - condition: state
        entity_id: switch.waveshare001_relay_3
        state: "off"
      # Прошло минимум 5 минут с последнего отключения (период покоя)
      - condition: or
        conditions:
          - condition: template
            value_template: "{{ states('input_datetime.fan_stop_time') == 'unknown' or states('input_datetime.fan_stop_time') == '' }}"
          - condition: template
            value_template: >-
              {{ (as_timestamp(now()) - as_timestamp(states.input_datetime.fan_stop_time.state)) / 60 >= 5 }}
      # Не в состоянии "Ожидание"
      - condition: not
        conditions:
          - condition: state
            entity_id: input_text.brooder_state
            state: "Ожидание"
    action:
      - service: switch.turn_on
        target:
          entity_id: switch.waveshare001_relay_3
      - service: input_datetime.set_datetime
        data:
          entity_id: input_datetime.fan_start_time
          timestamp: "{{ now().timestamp() | int }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.fan_reason
          value: "temperature"
      - service: script.send_notify
        data:
          message: >-
            Вентилятор включён по температуре (перегрев). Температура {{ states('sensor.waveshare001_rs485_temperature_10') }}°C
            (макс {{ states('input_number.max_temp') }}°C).

  # 3. Работа вентилятора - проверка условий каждую минуту
  - alias: "[Брудер] Вентилятор – проверка условий работы (каждую минуту)"
    trigger:
      - platform: time_pattern
        minutes: "/1"
    condition:
      # Автоматический режим включен
      - condition: state
        entity_id: input_boolean.avtomaticheskii_rezhim
        state: "on"
      # НЕ в ручном режиме
      - condition: state
        entity_id: input_boolean.ruchnoi_rezhim
        state: "off"
      # Вентилятор включен
      - condition: state
        entity_id: switch.waveshare001_relay_3
        state: "on"
    action:
      - choose:
          # 3.1 Если причина = ВЛАЖНОСТЬ
          - conditions:
              - condition: state
                entity_id: input_text.fan_reason
                state: "humidity"
              # Условия для продолжения работы НЕ выполняются
              - condition: or
                conditions:
                  # Влажность упала до min_hum или ниже
                  - condition: template
                    value_template: >-
                      {{ states('sensor.waveshare001_rs485_humidity_10')|float <= states('input_number.min_hum')|float }}
                  # Температура упала до min_temp или ниже
                  - condition: template
                    value_template: >-
                      {{ states('sensor.waveshare001_rs485_temperature_10')|float <= states('input_number.min_temp')|float }}
            sequence:
              - choose:
                  # Отключение: влажность ≤ min_hum И время работы >= fan_min_on
                  - conditions:
                      - condition: template
                        value_template: >-
                          {{ states('sensor.waveshare001_rs485_humidity_10')|float <= states('input_number.min_hum')|float }}
                      - condition: template
                        value_template: >-
                          {{ (as_timestamp(now()) - as_timestamp(states.input_datetime.fan_start_time.state)) / 60 >= states('input_number.fan_min_on')|int }}
                    sequence:
                      - service: switch.turn_off
                        target:
                          entity_id: switch.waveshare001_relay_3
                      - service: input_datetime.set_datetime
                        data:
                          entity_id: input_datetime.fan_stop_time
                          timestamp: "{{ now().timestamp() | int }}"
                      - service: input_text.set_value
                        data:
                          entity_id: input_text.fan_reason
                          value: ""
                      - service: script.send_notify
                        data:
                          message: >-
                            Вентилятор отключён (влажность). Влажность нормализовалась до {{ states('sensor.waveshare001_rs485_humidity_10') }}%
                            (минимум {{ states('input_number.min_hum') }}%). Время работы: {{ ((as_timestamp(now()) - as_timestamp(states.input_datetime.fan_start_time.state)) / 60)|int }} мин.
          # 3.2 Если причина = ТЕМПЕРАТУРА
          - conditions:
              - condition: state
                entity_id: input_text.fan_reason
                state: "temperature"
              # Температура упала до температуры возврата (max_temp - гистерезис) или ниже
              - condition: template
                value_template: >-
                  {{ states('sensor.waveshare001_rs485_temperature_10')|float <= (states('input_number.max_temp')|float - states('input_number.temp_fan_hysteresis')|float) }}
              # Время работы >= fan_min_on
              - condition: template
                value_template: >-
                  {{ (as_timestamp(now()) - as_timestamp(states.input_datetime.fan_start_time.state)) / 60 >= states('input_number.fan_min_on')|int }}
            sequence:
              - service: switch.turn_off
                target:
                  entity_id: switch.waveshare001_relay_3
              - service: input_datetime.set_datetime
                data:
                  entity_id: input_datetime.fan_stop_time
                  timestamp: "{{ now().timestamp() | int }}"
              - service: input_text.set_value
                data:
                  entity_id: input_text.fan_reason
                  value: ""
              - service: script.send_notify
                data:
                  message: >-
                    Вентилятор отключён (температура). Температура нормализовалась до {{ states('sensor.waveshare001_rs485_temperature_10') }}°C
                    (порог отключения {{ (states('input_number.max_temp')|float - states('input_number.temp_fan_hysteresis')|float)|round(1) }}°C). Время работы: {{ ((as_timestamp(now()) - as_timestamp(states.input_datetime.fan_start_time.state)) / 60)|int }} мин.

  # 5. Защита минимальной температуры (НЕ работает в ручном режиме)
  - alias: "[Брудер] Вентилятор – защита минимальной температуры"
    trigger:
      - platform: template
        value_template: "{{ states('sensor.waveshare001_rs485_temperature_10')|float <= (states('input_number.min_temp')|float + 0.01) }}"
    condition:
      # Автоматический режим включен
      - condition: state
        entity_id: input_boolean.avtomaticheskii_rezhim
        state: "on"
      # НЕ в ручном режиме
      - condition: state
        entity_id: input_boolean.ruchnoi_rezhim
        state: "off"
      # Вентилятор включен
      - condition: state
        entity_id: switch.waveshare001_relay_3
        state: "on"
    action:
      - service: switch.turn_off
        target:
          entity_id: switch.waveshare001_relay_3
      - service: input_datetime.set_datetime
        data:
          entity_id: input_datetime.fan_stop_time
          timestamp: "{{ now().timestamp() | int }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.fan_reason
          value: ""
      - service: script.send_notify
        data:
          message: >-
            Вентилятор отключён! Температура упала до {{ states('sensor.waveshare001_rs485_temperature_10') }}°C
            (минимум {{ states('input_number.min_temp') }}°C). Защита от переохлаждения (приоритет над всеми режимами).

  # -------------------------------------------------
  # 1.7 Остановка – кнопка Стоп
  # -------------------------------------------------
  - alias: "[Брудер] Остановка – кнопка Стоп"
    trigger:
      - platform: state
        entity_id: input_button.stop_brooder
    action:
      - service: script.stop_brooder

  # -------------------------------------------------
  # 1.8 Ручной режим → отключение автоматического режима
  # -------------------------------------------------
  - alias: "[Брудер] Ручной режим → отключение автоматического режима"
    trigger:
      - platform: state
        entity_id: input_boolean.ruchnoi_rezhim
        to: "on"
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.avtomaticheskii_rezhim
      - service: script.send_notify
        data:
          message: "Ручной режим включен. Автоматический режим отключен."

  # -------------------------------------------------
  # 1.9 Автоматический режим → отключение ручного режима
  # -------------------------------------------------
  - alias: "[Брудер] Автоматический режим → отключение ручного режима"
    trigger:
      - platform: state
        entity_id: input_boolean.avtomaticheskii_rezhim
        to: "on"
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.ruchnoi_rezhim
      - service: script.send_notify
        data:
          message: "Автоматический режим включен. Ручной режим отключен."

  # 6. Связка с ТЭНами (важно)
  # Если влажность > max_hum, но температура < dehum_min_temp, вентилятор НЕ включается
  # ТЭНы работают по своей логике, пока температура не поднимется
  # После достижения dehum_min_temp → разрешается включение вентилятора по влажности
  # Эта логика уже реализована в автоматизации включения по влажности (условие: температура >= dehum_min_temp)
